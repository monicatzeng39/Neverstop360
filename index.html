import React, { useState, useEffect } from 'react';
import { Upload, Wind, Utensils, Zap, Clock, Bike, AlertCircle, PlayCircle, FileText, CheckCircle } from 'lucide-react';

// --- é è¨­å¸¸æ•¸èˆ‡è³‡æ–™ ---

// åŒ—é«˜360 åˆ†æ®µå®šç¾©
const SEGMENTS = [
  { id: 1, name: "ç¬¬ä¸€æ®µï¼šé—œæ¸¡ â†’ æ–°ç«¹ä»£å¤©åºœ", start: 0, end: 75.5, note: "è¥¿æ¿±èµ·é»ï¼Œé«”åŠ›å……æ²›" },
  { id: 2, name: "ç¬¬äºŒæ®µï¼šæ–°ç«¹ä»£å¤©åºœ â†’ ä¼¸æ¸¯å¯¶å¤©å®®", start: 75.5, end: 168, note: "ç¶“è‹—æ —å¾Œé¾å¡ï¼Œé€²å…¥å°ä¸­" },
  { id: 3, name: "ç¬¬ä¸‰æ®µï¼šä¼¸æ¸¯å¯¶å¤©å®® â†’ å¸ƒè¢‹å¤§çœ¾å»Ÿ", start: 168, end: 275, note: "å½°åŒ–é›²æ—å˜‰ç¾©å¹³è·¯ï¼Œç„¡ç›¡çš„é»‘æš—è·¯æ®µ" },
  { id: 4, name: "ç¬¬å››æ®µï¼šå¸ƒè¢‹å¤§çœ¾å»Ÿ â†’ å·¦ç‡Ÿå¤§ç¾©åœ‹ä¸­", start: 275, end: 367.6, note: "å°å—å¸‚å€ç´…ç¶ ç‡ˆèˆ‡æœ€å¾Œçš„æ„å¿—åŠ›" }
];

// é è¨­è£œçµ¦å»ºè­°é»
const STOPS = [
  { name: "æ–°ç«¹ä»£å¤©åºœ", km: 75.5, type: "å®®å»Ÿ/ä¾¿åˆ©å•†åº—" },
  { name: "ä¼¸æ¸¯å¯¶å¤©å®®", km: 168, type: "å®®å»Ÿ/è£œçµ¦è»Š" },
  { name: "å¸ƒè¢‹å¤§çœ¾å»Ÿ", km: 275, type: "å®®å»Ÿ/ä¾¿åˆ©å•†åº—" },
  { name: "æ¥ æ¢“ (éº¥ç•¶å‹/è¶…å•†)", km: 340, type: "å¸‚å€è£œçµ¦é»" },
  { name: "çµ‚é» (å¤§ç¾©åœ‹ä¸­)", km: 367.6, type: "çµ‚é»" }
];

// è£œçµ¦å»ºè­°é¸å–®
const FOOD_SUGGESTIONS = {
  early: "é£¯ç³°ã€ä¸‰æ˜æ²»ã€é¦™è•‰ (å›ºæ…‹ç‚ºä¸»)",
  mid: "éºµåŒ…ã€è›‹ç³•ã€æœè† ã€BCAA (å›ºæ¶²ä¸¦é‡)",
  late: "å¯æ¨‚ã€æµè³ªé£Ÿç‰©ã€æœè† ã€å’–å•¡å›  (å¿«é€Ÿå¸æ”¶)",
  recovery: "å·§å…‹åŠ›ç‰›å¥¶ã€è±†æ¼¿ã€é›èƒ¸è‚‰"
};

const BeiGaoPlanner = () => {
  // --- ç‹€æ…‹ç®¡ç† ---
  
  // ä½¿ç”¨è€…è¨­å®š
  const [config, setConfig] = useState({
    carbsPerHour: 70, // g
    waterPerHour: 600, // ml
    sodiumPerHour: 500, // mg
    carbsPerGel: 25, // g
    sodiumPerPill: 300, // mg
    windDirection: 'tail', // tail, head, side, none
    windSpeed: 15, // km/h
    startTime: "00:00", // å‡ºç™¼æ™‚é–“
  });

  // æª”æ¡ˆèˆ‡èƒ½åŠ›ç‹€æ…‹
  const [fileStatus, setFileStatus] = useState({
    fileName: null,
    isReady: false,
    fileType: null, // 'gpx' or 'fit' or 'demo'
    baseSpeed: 0
  });

  // è¨ˆç®—çµæœ
  const [results, setResults] = useState(null);
  const [activeTab, setActiveTab] = useState('summary');
  const [isProcessing, setIsProcessing] = useState(false);

  // --- é‚è¼¯è™•ç† ---

  // 1. æª”æ¡ˆä¸Šå‚³è™•ç†
  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    // é‡ç½®ä¹‹å‰çš„çµæœ
    setResults(null);
    setIsProcessing(true);

    const fileName = file.name.toLowerCase();
    
    if (fileName.endsWith('.fit')) {
      // FIT æª”æ¡ˆè™•ç† (æ¨¡æ“¬)
      // ç”±æ–¼ç€è¦½å™¨ç’°å¢ƒç„¡ external libraries è§£æäºŒé€²ä½ FITï¼Œé€™è£¡æ¡ç”¨æ¨¡æ“¬ç­–ç•¥
      setTimeout(() => {
        setFileStatus({
          fileName: file.name,
          isReady: true,
          fileType: 'fit',
          baseSpeed: 30.0 // çµ¦äºˆä¸€å€‹è¼ƒé«˜çš„é è¨­å€¼ï¼Œæ¨¡æ“¬ FIT ç”¨æˆ¶é€šå¸¸æœ‰åŠŸç‡è¨ˆä¸”èƒ½åŠ›è¼ƒå¥½
        });
        setIsProcessing(false);
      }, 800);
      
    } else if (fileName.endsWith('.gpx')) {
      // GPX æª”æ¡ˆè™•ç† (çœŸå¯¦è§£æ)
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
          const trkpts = xmlDoc.getElementsByTagName("trkpt");
          
          if (trkpts.length < 2) {
            alert("GPX æª”æ¡ˆç„¡æ•ˆæˆ–é»æ•¸éå°‘");
            setIsProcessing(false);
            return;
          }

          let totalDist = 0;
          let totalMovingTime = 0; // seconds
          let lastLat = parseFloat(trkpts[0].getAttribute("lat"));
          let lastLon = parseFloat(trkpts[0].getAttribute("lon"));
          let lastTime = new Date(trkpts[0].getElementsByTagName("time")[0].textContent).getTime();

          for (let i = 1; i < trkpts.length; i++) {
            const lat = parseFloat(trkpts[i].getAttribute("lat"));
            const lon = parseFloat(trkpts[i].getAttribute("lon"));
            const timeStr = trkpts[i].getElementsByTagName("time")[0]?.textContent;
            
            if (!timeStr) continue;
            
            const time = new Date(timeStr).getTime();
            const timeDiff = (time - lastTime) / 1000;

            // Haversine formula
            const R = 6371; 
            const dLat = (lat - lastLat) * Math.PI / 180;
            const dLon = (lon - lastLon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lastLat * Math.PI / 180) * Math.cos(lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const dist = R * c;

            if (dist > 0) {
              const speed = (dist / (timeDiff / 3600));
              if (speed > 3 && speed < 100 && timeDiff < 120) {
                  totalDist += dist;
                  totalMovingTime += timeDiff;
              }
            }

            lastLat = lat;
            lastLon = lon;
            lastTime = time;
          }

          const calculatedAvgSpeed = totalDist / (totalMovingTime / 3600);
          
          if (isNaN(calculatedAvgSpeed) || calculatedAvgSpeed < 5) {
               alert("ç„¡æ³•å¾ GPX è¨ˆç®—æœ‰æ•ˆé€Ÿåº¦ï¼Œè«‹ç¢ºèªæª”æ¡ˆã€‚");
               setIsProcessing(false);
               return;
          }

          setFileStatus({
            fileName: file.name,
            isReady: true,
            fileType: 'gpx',
            baseSpeed: parseFloat(calculatedAvgSpeed.toFixed(1))
          });
          setIsProcessing(false);

        } catch (err) {
          console.error(err);
          alert("GPX è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ã€‚");
          setIsProcessing(false);
        }
      };
      reader.readAsText(file);
    } else {
      alert("ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä¸Šå‚³ .gpx æˆ– .fit");
      setIsProcessing(false);
    }
  };

  // å•Ÿç”¨ç¤ºç¯„æ¨¡å¼
  const useDemoData = () => {
      setResults(null);
      setFileStatus({
          fileName: "Demo_Ride_Data.gpx (æ¨¡æ“¬æ•¸æ“š)",
          isReady: true,
          fileType: 'demo',
          baseSpeed: 28.5
      });
  };

  // 2. æ ¸å¿ƒè¨ˆç®—å¼•æ“ (é»æ“ŠæŒ‰éˆ•å¾Œè§¸ç™¼)
  const generateReport = () => {
    if (!fileStatus.isReady) return;

    // A. é¢¨é˜»ä¿‚æ•¸ä¿®æ­£
    let windFactor = 0;
    if (config.windDirection === 'tail') windFactor = config.windSpeed * 0.25; 
    if (config.windDirection === 'head') windFactor = -(config.windSpeed * 0.4); 
    if (config.windDirection === 'side') windFactor = -(config.windSpeed * 0.05);

    const adjustedBaseSpeed = fileStatus.baseSpeed + windFactor;

    // B. åˆ†æ®µè¨ˆç®— (åŠ å…¥ç–²å‹è¡°é€€)
    let currentTimeInHours = 0; 
    let cumulativeDist = 0;
    
    const [startH, startM] = config.startTime.split(':').map(Number);
    const startDate = new Date();
    startDate.setHours(startH, startM, 0, 0);

    const segmentResults = SEGMENTS.map((seg) => {
      const segDist = seg.end - seg.start;
      
      const fatigueDrop = (seg.start / 100) * 0.04; 
      const fatigueFactor = Math.max(0.6, 1 - fatigueDrop); 

      const predictedSpeed = Math.max(10, adjustedBaseSpeed * fatigueFactor); 
      const durationHours = segDist / predictedSpeed;

      currentTimeInHours += durationHours;
      cumulativeDist = seg.end;

      const totalCarbs = Math.ceil(durationHours * config.carbsPerHour);
      const totalWater = Math.ceil(durationHours * config.waterPerHour);
      const totalSodium = Math.ceil(durationHours * config.sodiumPerHour);

      return {
        ...seg,
        dist: segDist.toFixed(1),
        avgSpeed: predictedSpeed.toFixed(1),
        duration: durationHours,
        durationFormatted: formatHoursToTime(durationHours),
        cumulativeTime: currentTimeInHours,
        cumulativeTimeFormatted: formatHoursToTime(currentTimeInHours),
        needs: {
          carbs: totalCarbs,
          water: totalWater,
          sodium: totalSodium,
          gels: Math.ceil(totalCarbs / config.carbsPerGel),
          pills: Math.ceil(totalSodium / config.sodiumPerPill)
        }
      };
    });

    // C. åœé é»è¨ˆç®—
    const stopResults = STOPS.map((stop) => {
        const targetSeg = segmentResults.find(s => stop.km > s.start && stop.km <= s.end) || segmentResults[segmentResults.length - 1];
        const distInSeg = stop.km - targetSeg.start;
        const timeInSeg = distInSeg / parseFloat(targetSeg.avgSpeed);
        
        const prevSegIndex = segmentResults.findIndex(s => s.id === targetSeg.id) - 1;
        const timeToStartOfSeg = prevSegIndex >= 0 ? segmentResults[prevSegIndex].cumulativeTime : 0;
        
        const totalHoursToStop = timeToStartOfSeg + timeInSeg;
        const arrivalTime = new Date(startDate.getTime() + totalHoursToStop * 3600 * 1000);
        
        let foodType = FOOD_SUGGESTIONS.early;
        if (stop.km > 150) foodType = FOOD_SUGGESTIONS.mid;
        if (stop.km > 270) foodType = FOOD_SUGGESTIONS.late;
        if (stop.type === "çµ‚é»") foodType = FOOD_SUGGESTIONS.recovery;

        const prevStopKm = STOPS.find(s => s.km < stop.km && STOPS.indexOf(s) === STOPS.indexOf(stop) - 1)?.km || 0;
        const distFromLastStop = stop.km - prevStopKm;
        const segmentSpeed = parseFloat(targetSeg.avgSpeed); 
        const timeFromLastStop = distFromLastStop / segmentSpeed;

        const needsFromLast = {
            carbs: Math.ceil(timeFromLastStop * config.carbsPerHour),
            water: Math.ceil(timeFromLastStop * config.waterPerHour),
            sodium: Math.ceil(timeFromLastStop * config.sodiumPerHour)
        };

        return {
            ...stop,
            eta: arrivalTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}),
            totalHours: totalHoursToStop,
            segmentTime: timeFromLastStop, 
            needs: needsFromLast,
            suggestion: foodType
        };
    });

    // D. ç¸½çµ
    const totalTime = currentTimeInHours;
    const totalCarbs = totalTime * config.carbsPerHour;
    const totalWater = totalTime * config.waterPerHour;
    const totalSodium = totalTime * config.sodiumPerHour;

    const fatigueWarning = stopResults.find(s => s.totalHours > 10)?.km || 250;

    setResults({
      segments: segmentResults,
      stops: stopResults,
      summary: {
        totalTime: formatHoursToTime(totalTime),
        totalTimeHours: totalTime.toFixed(1),
        finishTime: new Date(startDate.getTime() + totalTime * 3600 * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false}),
        avgSpeed: (367.6 / totalTime).toFixed(1),
        totalNeeds: {
          carbs: Math.ceil(totalCarbs),
          water: Math.ceil(totalWater / 1000 * 10) / 10,
          sodium: Math.ceil(totalSodium),
          gels: Math.ceil(totalCarbs / config.carbsPerGel),
          pills: Math.ceil(totalSodium / config.sodiumPerPill)
        },
        fatigueWarning
      }
    });

    // è‡ªå‹•æ²å‹•åˆ°çµæœå€
    setTimeout(() => {
        document.getElementById('results-section')?.scrollIntoView({ behavior: 'smooth' });
    }, 100);
  };

  const formatHoursToTime = (totalHours) => {
    const hours = Math.floor(totalHours);
    const minutes = Math.floor((totalHours - hours) * 60);
    return `${hours}å°æ™‚ ${minutes}åˆ†`;
  };

  const handleConfigChange = (e) => {
    const { name, value } = e.target;
    setConfig(prev => ({ ...prev, [name]: name.includes('Direction') || name.includes('startTime') ? value : Number(value) }));
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-12">
      {/* Header */}
      <header className="bg-blue-700 text-white p-6 shadow-lg">
        <div className="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center">
          <div className="flex items-center gap-3 mb-4 md:mb-0">
            <Bike size={32} />
            <div>
              <h1 className="text-2xl font-bold">åŒ—é«˜ 360 å®Œè³½é…é€Ÿèˆ‡è£œçµ¦è¨ˆç®—æ©Ÿ</h1>
              <p className="text-blue-200 text-sm">æ”¯æ´ Strava GPX / FIT ç´€éŒ„åˆ†æ</p>
            </div>
          </div>
          <div className="text-right text-blue-100 text-sm">
            ç‰ˆæœ¬: 2.0 (æ”¯æ´æ‰‹å‹•ç”Ÿæˆ)
          </div>
        </div>
      </header>

      <main className="max-w-5xl mx-auto p-4 md:p-6 space-y-6">
        
        {/* Top Section: Upload & Settings */}
        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
          
          {/* Left Col: Upload & Wind */}
          <div className="md:col-span-5 space-y-4">
            {/* Upload Card */}
            <div className={`p-5 rounded-xl shadow-sm border transition-all ${fileStatus.isReady ? 'bg-green-50 border-green-200' : 'bg-white border-slate-200'}`}>
              <h2 className="text-lg font-semibold flex items-center gap-2 mb-4 text-slate-800">
                <Upload size={20} className={fileStatus.isReady ? "text-green-600" : "text-blue-600"} />
                1. ä¸Šå‚³é¨ä¹˜ç´€éŒ„
              </h2>
              
              {!fileStatus.isReady ? (
                <div className="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition-colors relative">
                    <input 
                      type="file" 
                      accept=".gpx,.fit" 
                      onChange={handleFileUpload} 
                      className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                      disabled={isProcessing}
                    />
                    <div className="space-y-2">
                      <div className="text-slate-400 mx-auto w-10 h-10 flex items-center justify-center">
                        {isProcessing ? <Clock className="animate-spin text-blue-500" /> : <Upload />}
                      </div>
                      <p className="text-sm font-medium text-slate-600">
                        {isProcessing ? "æª”æ¡ˆåˆ†æä¸­..." : "é»æ“Šä¸Šå‚³ GPX æˆ– FIT"}
                      </p>
                      <p className="text-xs text-slate-400">
                        æ”¯æ´ Garmin/Strava åŒ¯å‡ºä¹‹æª”æ¡ˆ
                      </p>
                    </div>
                </div>
              ) : (
                <div className="space-y-3">
                    <div className="flex items-start gap-3 bg-white/60 p-3 rounded-lg border border-green-100">
                        <FileText className="text-green-600 mt-1" size={20} />
                        <div>
                            <div className="font-bold text-green-800">æª”æ¡ˆè®€å–æˆåŠŸ</div>
                            <div className="text-sm text-green-700 break-all">{fileStatus.fileName}</div>
                            <div className="text-xs text-green-600 mt-1">
                                {fileStatus.fileType === 'fit' ? 
                                    "(FIT æª”å·²æ¨¡æ“¬è®€å–ï¼Œä½¿ç”¨æ¨™æº–ä¼°è¨ˆå€¼)" : 
                                    `(åˆ†æåŸºæº–å‡é€Ÿ: ${fileStatus.baseSpeed} km/h)`}
                            </div>
                        </div>
                    </div>
                    <button 
                        onClick={() => {
                            setFileStatus({ fileName: null, isReady: false, fileType: null, baseSpeed: 0 });
                            setResults(null);
                        }}
                        className="text-xs text-slate-500 underline hover:text-slate-700 w-full text-center"
                    >
                        é‡æ–°ä¸Šå‚³æª”æ¡ˆ
                    </button>
                </div>
              )}

              {!fileStatus.isReady && !isProcessing && (
                 <div className="mt-4 text-center">
                   <span className="text-sm text-slate-500">æˆ–æ˜¯</span>
                   <button 
                    onClick={useDemoData}
                    className="ml-2 text-sm text-blue-600 font-semibold hover:underline"
                   >
                     ä½¿ç”¨ç¯„ä¾‹æ•¸æ“šè©¦ç®—
                   </button>
                 </div>
              )}
            </div>

            {/* Wind Settings */}
            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
              <h2 className="text-lg font-semibold flex items-center gap-2 mb-4">
                <Wind size={20} className="text-blue-600" />
                2. ç’°å¢ƒè¨­å®š
              </h2>
              <div className="space-y-4">
                <div>
                  <label className="text-sm font-medium text-slate-700 block mb-1">é ä¼°é¢¨å‘</label>
                  <select 
                    name="windDirection" 
                    value={config.windDirection} 
                    onChange={handleConfigChange}
                    className="w-full p-2 border border-slate-300 rounded-md text-sm"
                  >
                    <option value="tail">åŒ—é¢¨ (å¤§é †é¢¨)</option>
                    <option value="none">ç„¡é¢¨</option>
                    <option value="side">å´é¢¨</option>
                    <option value="head">å—é¢¨ (å¤§é€†é¢¨)</option>
                  </select>
                </div>
                <div>
                  <label className="text-sm font-medium text-slate-700 flex justify-between mb-1">
                    <span>é¢¨é€Ÿå¼·åº¦</span>
                    <span className="text-blue-600">{config.windSpeed} km/h</span>
                  </label>
                  <input 
                    type="range" 
                    name="windSpeed" 
                    min="0" max="40" 
                    value={config.windSpeed} 
                    onChange={handleConfigChange}
                    className="w-full accent-blue-600" 
                  />
                </div>
                 <div>
                  <label className="text-sm font-medium text-slate-700 block mb-1">å‡ºç™¼æ™‚é–“</label>
                  <input 
                    type="time" 
                    name="startTime" 
                    value={config.startTime} 
                    onChange={handleConfigChange}
                    className="w-full p-2 border border-slate-300 rounded-md text-sm"
                  />
                </div>
              </div>
            </div>
          </div>

          {/* Right Col: Nutrition Config & Action */}
          <div className="md:col-span-7 flex flex-col gap-6">
            <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex-grow">
               <h2 className="text-lg font-semibold flex items-center gap-2 mb-4">
                <Utensils size={20} className="text-blue-600" />
                3. è£œçµ¦ç­–ç•¥è¨­å®š
              </h2>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                
                {/* éœ€æ±‚è¨­å®š */}
                <div className="space-y-4">
                  <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">æ¯å°æ™‚éœ€æ±‚</h3>
                  <div>
                    <label className="text-sm text-slate-700 block mb-1">ç¢³æ°´åŒ–åˆç‰© (g/hr)</label>
                    <div className="flex items-center gap-2">
                       <input 
                        type="number" name="carbsPerHour" 
                        value={config.carbsPerHour} onChange={handleConfigChange}
                        className="w-20 p-2 border border-slate-300 rounded-md"
                      />
                      <span className="text-xs text-slate-500">å»ºè­° 60-90g</span>
                    </div>
                  </div>
                  <div>
                    <label className="text-sm text-slate-700 block mb-1">é£²æ°´ (ml/hr)</label>
                     <div className="flex items-center gap-2">
                      <input 
                        type="number" name="waterPerHour" 
                        value={config.waterPerHour} onChange={handleConfigChange}
                        className="w-20 p-2 border border-slate-300 rounded-md"
                      />
                      <span className="text-xs text-slate-500">å»ºè­° 500-800ml</span>
                    </div>
                  </div>
                  <div>
                    <label className="text-sm text-slate-700 block mb-1">éˆ‰/é›»è§£è³ª (mg/hr)</label>
                     <div className="flex items-center gap-2">
                      <input 
                        type="number" name="sodiumPerHour" 
                        value={config.sodiumPerHour} onChange={handleConfigChange}
                        className="w-20 p-2 border border-slate-300 rounded-md"
                      />
                      <span className="text-xs text-slate-500">ä¾æ’æ±—é‡èª¿æ•´</span>
                    </div>
                  </div>
                </div>

                {/* è£œçµ¦å“è¦æ ¼ */}
                <div className="space-y-4 bg-slate-50 p-4 rounded-lg">
                   <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider">è£œçµ¦å“è¦æ ¼æ›ç®—</h3>
                   <div>
                    <label className="text-sm text-slate-700 block mb-1">èƒ½é‡è† ç¢³æ°´å«é‡ (g/åŒ…)</label>
                    <input 
                        type="number" name="carbsPerGel" 
                        value={config.carbsPerGel} onChange={handleConfigChange}
                        className="w-full p-2 border border-slate-300 rounded-md bg-white"
                      />
                   </div>
                   <div>
                    <label className="text-sm text-slate-700 block mb-1">é›»è§£è³ªéŒ å«éˆ‰é‡ (mg/é¡†)</label>
                    <input 
                        type="number" name="sodiumPerPill" 
                        value={config.sodiumPerPill} onChange={handleConfigChange}
                        className="w-full p-2 border border-slate-300 rounded-md bg-white"
                      />
                   </div>
                </div>
              </div>
            </div>

            {/* Generate Button Area */}
            <div className="bg-slate-100 p-4 rounded-xl border border-slate-200 flex flex-col items-center justify-center text-center">
                <button
                    onClick={generateReport}
                    disabled={!fileStatus.isReady}
                    className={`
                        w-full md:w-auto px-8 py-4 rounded-full font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all transform
                        ${fileStatus.isReady 
                            ? 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:scale-105 hover:shadow-blue-500/30 cursor-pointer' 
                            : 'bg-slate-300 text-slate-500 cursor-not-allowed'}
                    `}
                >
                    <PlayCircle size={24} />
                    {results ? "é‡æ–°è¨ˆç®—æ•¸æ“š" : "é–‹å§‹åˆ†æä¸¦ç”¢ç”Ÿå ±å‘Š"}
                </button>
                {!fileStatus.isReady && (
                    <p className="text-xs text-slate-400 mt-2">è«‹å…ˆå®Œæˆæ­¥é©Ÿ 1 ä¸Šå‚³æª”æ¡ˆ</p>
                )}
            </div>

          </div>
        </div>

        {/* Results Section */}
        {results && (
          <div id="results-section" className="space-y-6 animate-fade-in pt-6 border-t border-slate-200">
             <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 pb-2">
                <div className="flex items-center gap-2">
                    <CheckCircle className="text-green-500" />
                    <h2 className="text-2xl font-bold text-slate-800">åˆ†æå®Œæˆ</h2>
                </div>
                <div className="flex bg-slate-100 p-1 rounded-lg self-start md:self-auto">
                  {['summary', 'segments', 'stops'].map(tab => (
                    <button
                      key={tab}
                      onClick={() => setActiveTab(tab)}
                      className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                        activeTab === tab 
                        ? 'bg-white text-blue-600 shadow-sm' 
                        : 'text-slate-500 hover:text-slate-700'
                      }`}
                    >
                      {tab === 'summary' && 'ç¸½çµæ¦‚è¦½'}
                      {tab === 'segments' && 'åˆ†æ®µé…é€Ÿ'}
                      {tab === 'stops' && 'è£œçµ¦åœé '}
                    </button>
                  ))}
                </div>
             </div>

             {/* Tab Content */}
             
             {/* 1. Summary View */}
             {activeTab === 'summary' && (
               <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                 {/* Total Time Card */}
                 <div className="bg-gradient-to-br from-blue-600 to-blue-700 text-white p-6 rounded-xl shadow-md">
                    <div className="text-blue-200 text-sm font-medium mb-1">é ä¼°å®Œè³½æ™‚é–“</div>
                    <div className="text-3xl font-bold mb-2">{results.summary.totalTime}</div>
                    <div className="flex justify-between items-end">
                      <div className="text-sm opacity-80">ETA: {results.summary.finishTime}</div>
                      <Clock className="opacity-50" />
                    </div>
                 </div>

                 {/* Speed Card */}
                 <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <div className="text-slate-500 text-sm font-medium mb-1">å…¨ç¨‹å¹³å‡å‡é€Ÿ</div>
                    <div className="text-3xl font-bold text-slate-800 mb-2">{results.summary.avgSpeed} <span className="text-lg font-normal text-slate-500">km/h</span></div>
                    <div className="flex items-center gap-1 text-xs text-orange-600">
                       <AlertCircle size={12} />
                       <span>{results.summary.fatigueWarning}k å¾Œé«”åŠ›é¡¯è‘—ä¸‹æ»‘</span>
                    </div>
                 </div>

                 {/* Nutrition Needs Card */}
                 <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 md:col-span-2">
                    <div className="text-slate-500 text-sm font-medium mb-3">ç¸½è£œçµ¦éœ€æ±‚æ¸…å–®</div>
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <div className="text-2xl font-bold text-slate-800">{results.summary.totalNeeds.gels}</div>
                        <div className="text-xs text-slate-500">åŒ…èƒ½é‡è†  ({results.summary.totalNeeds.carbs}g)</div>
                      </div>
                      <div>
                        <div className="text-2xl font-bold text-slate-800">{results.summary.totalNeeds.pills}</div>
                        <div className="text-xs text-slate-500">é¡†é¹½éŒ  ({results.summary.totalNeeds.sodium}mg)</div>
                      </div>
                      <div>
                        <div className="text-2xl font-bold text-slate-800">{results.summary.totalNeeds.water}L</div>
                        <div className="text-xs text-slate-500">é£²ç”¨æ°´</div>
                      </div>
                    </div>
                 </div>
               </div>
             )}

             {/* 2. Segments View */}
             {activeTab === 'segments' && (
               <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                 <div className="overflow-x-auto">
                   <table className="w-full text-sm text-left">
                     <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                       <tr>
                         <th className="px-6 py-4">è·¯æ®µè³‡è¨Š</th>
                         <th className="px-6 py-4 text-center">è·é›¢</th>
                         <th className="px-6 py-4 text-center">é ä¼°å‡é€Ÿ</th>
                         <th className="px-6 py-4 text-center">é¨ä¹˜æ™‚é–“</th>
                         <th className="px-6 py-4">æœ¬æ®µè£œçµ¦å»ºè­°</th>
                       </tr>
                     </thead>
                     <tbody className="divide-y divide-slate-100">
                       {results.segments.map((seg) => (
                         <tr key={seg.id} className="hover:bg-slate-50 transition-colors">
                           <td className="px-6 py-4">
                             <div className="font-bold text-slate-800">{seg.name}</div>
                             <div className="text-xs text-slate-500 mt-1">{seg.note}</div>
                           </td>
                           <td className="px-6 py-4 text-center">
                             <span className="font-mono font-medium">{seg.dist}</span> km
                           </td>
                           <td className="px-6 py-4 text-center">
                             <span className={`font-mono font-bold ${parseFloat(seg.avgSpeed) < 20 ? 'text-red-500' : 'text-blue-600'}`}>
                               {seg.avgSpeed}
                             </span> km/h
                           </td>
                           <td className="px-6 py-4 text-center">
                             <div className="font-medium">{seg.durationFormatted}</div>
                             <div className="text-xs text-slate-400">ç´¯è¨ˆ: {seg.cumulativeTimeFormatted}</div>
                           </td>
                           <td className="px-6 py-4">
                             <div className="flex flex-wrap gap-2 text-xs">
                               <span className="bg-orange-100 text-orange-700 px-2 py-1 rounded-full">
                                 ç¢³æ°´ {seg.needs.carbs}g ({seg.needs.gels}è† )
                               </span>
                               <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                                 æ°´ {seg.needs.water}ml
                               </span>
                               <span className="bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                                 é¹½éŒ  {seg.needs.pills}é¡†
                               </span>
                             </div>
                           </td>
                         </tr>
                       ))}
                     </tbody>
                   </table>
                 </div>
               </div>
             )}

             {/* 3. Stops View */}
             {activeTab === 'stops' && (
               <div className="grid grid-cols-1 gap-4">
                  {results.stops.map((stop, idx) => (
                    <div key={idx} className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col md:flex-row gap-4 items-center">
                        <div className="bg-blue-600 text-white rounded-lg p-3 w-full md:w-32 text-center shrink-0">
                           <div className="text-xs opacity-80 font-medium">æŠµé”æ™‚é–“</div>
                           <div className="text-2xl font-bold">{stop.eta}</div>
                        </div>
                        
                        <div className="flex-grow min-w-0">
                           <div className="flex items-center gap-2 mb-1">
                             <h3 className="font-bold text-lg text-slate-800">{stop.name}</h3>
                             <span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-600 border border-slate-200">
                               {stop.km}km
                             </span>
                           </div>
                           <div className="text-sm text-slate-500 mb-2">
                             {stop.type} â€¢ è·é›¢ä¸Šä¸€ç«™ {(stop.segmentTime * parseFloat(results.segments[0].avgSpeed)).toFixed(1)}km (ç´„ {formatHoursToTime(stop.segmentTime)})
                           </div>
                           
                           {stop.name !== "çµ‚é» (å¤§ç¾©åœ‹ä¸­)" && (
                             <div className="bg-slate-50 p-3 rounded-lg text-sm border border-slate-100">
                                <div className="font-semibold text-slate-700 mb-1 flex items-center gap-1">
                                  <Utensils size={14} /> å»ºè­°è£œçµ¦å…§å®¹
                                </div>
                                <div className="text-slate-600 mb-2">{stop.suggestion}</div>
                                <div className="flex gap-3 text-xs text-slate-500">
                                  <span>éœ€è£œæ°´: <strong>{stop.needs.water}ml</strong></span>
                                  <span>éœ€è£œç¢³: <strong>{stop.needs.carbs}g</strong></span>
                                  <span>éœ€è£œéˆ‰: <strong>{stop.needs.sodium}mg</strong></span>
                                </div>
                             </div>
                           )}
                           
                           {stop.name === "çµ‚é» (å¤§ç¾©åœ‹ä¸­)" && (
                             <div className="bg-green-50 text-green-800 p-3 rounded-lg text-sm font-medium">
                               ğŸ‰ æ­å–œå®Œè³½ï¼è«‹ç«‹å³è£œå……æ¢å¾©é£²å“ï¼ˆå·§å…‹åŠ›ç‰›å¥¶/è±†æ¼¿ï¼‰èˆ‡å„ªè³ªè›‹ç™½è³ªã€‚
                             </div>
                           )}
                        </div>
                    </div>
                  ))}
               </div>
             )}

          </div>
        )}
      </main>
    </div>
  );
};

export default BeiGaoPlanner;